doctype html
html
	head
		title Miaou - Profile
		link(rel="icon",type="image/png",href="static/M-32.png")
		link(rel='stylesheet', href='static/main.css')
		script(src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js")
		script(src="static/miaou.min.js")
		style.
			#p {
				padding: 2px;
				background: #F0EAD6;
			}
	body.home
		section#home-top
			div.thinMP
				a(href='.')
					img(src="static/Miaou-300-f.png")
		section#home-notifs
			div.thinMP
				h2 Public Profile
		section#home-main
			div.thinMP
				form(method="post")
					input(type="hidden", name="secret", value=secret)
					input#id(type="hidden", name="id")
					table.form
						tr
							th Name
							td
								input#name(type="text", name="name", value=suggestedName, pattern="\\w[\\w_\\-\\d]{2,19}")
						tr
							th About me
							td
								input#description(type="text", name="description", maxlength="250")
						tr
							th Prefered Language (if any)
							td
								select#lang(name="lang")
						tr
							th Location
							td
								input#location(type="text", name="location", value="", maxlength="250")
						tr
							th Web Site
							td
								input#url(type="url", name="url", value="", maxlength="250")
						tr
							th External Profiles
							td
								each ep in externalProfileInfos
									section.externalProfileForm
										h3.section-opener= ep.name
										section
											if ep.html
												div.externalProfile !{ep.html}
												div.inputs
													- var cbid = "remove_"+ep.name
													input(type="checkbox",name=cbid,id=cbid)
													label(for=cbid) Remove this profile
											else
												table
													each field in ep.fields
														tr
															td
																label= field.label+' : '
															td
																input(type=(field.type||'text'),name=field.name)
												if ep.creationDescription
													p !{ep.creationDescription}
					p#err.error= error
					div.dialog-buttons
						button#submit Save
						button#close Rooms
		script.
			var externalProfileInfos = !{JSON.stringify(externalProfileInfos)},
				valid = !{JSON.stringify(valid)},
				langs = !{langs},
				userinfo = !{userinfo};
			for (var key in langs) {
				var lang = langs[key];
				$('#lang').append($('<option>').attr('value', key).text(lang.name));
			}
			$('#name').focus().keyup(function(){
				if (!this.validity.valid){ // not compatible with IE, that's fine 
					$('#err').text('Please type a name with 3 to 20 standard characters, digits, "_" or "-"');
					$('#submit').prop('disabled', true);
				} else if (/w+[_-]*[iy]+[_-]*s+[_-]*e+[_-]*l+[_-]*[iy]+/i.test(this.value)) {
					$('#err').text('More wisely, less "wisely", please.');
					$('#submit').prop('disabled', true);
				} else {
					$('#err').text('');
					$('#submit').prop('disabled', false);
				}
			});
			$('#description').val(userinfo.description||'');
			$('#location').val(userinfo.location||'');
			$('#url').val(userinfo.url||'');
			$('#lang').val(userinfo.lang);
			
			if (!valid) $('#close').hide();
			$('#close').click(function(){ location = 'rooms'; return false; });
						
			$('.section-opener + section').hide();
			$('.section-opener').click(function(){
				$(this).toggleClass('section-opener section-closer').next('section').toggle();
			});
